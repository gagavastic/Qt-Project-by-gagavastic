[gd_scene load_steps=16 format=3 uid="uid://byaj5xalkp2xn"]

[ext_resource type="Texture2D" uid="uid://dqcxnpi5j7w5j" path="res://kingscelet-Photoroom.png" id="1_pw6g7"]
[ext_resource type="Texture2D" uid="uid://mchwpw2osm0n" path="res://kingsceletатака-Photoroom.png" id="2_hm1qr"]
[ext_resource type="Texture2D" uid="uid://cb5edq7tmoyd7" path="res://kingsceletатака2-Photoroom.png" id="3_4ikyj"]
[ext_resource type="Texture2D" uid="uid://boiarouie0xf8" path="res://kingsceletнизатака-Photoroom.png" id="4_ll65m"]
[ext_resource type="Texture2D" uid="uid://bj8cjkf5f43mh" path="res://kingsceletнизатака2-Photoroom.png" id="5_kpn47"]
[ext_resource type="Texture2D" uid="uid://d04krijtyc5tr" path="res://kingsceletрывок-Photoroom.png" id="6_trgko"]
[ext_resource type="Texture2D" uid="uid://cbcbbrg2r6kjs" path="res://kingsceletрывок2-Photoroom.png" id="7_vr30h"]
[ext_resource type="Texture2D" uid="uid://bfrwtsqu3he5t" path="res://kingsceletатака1-Photoroom.png" id="8_ws33q"]

[sub_resource type="GDScript" id="GDScript_pw6g7"]
resource_name = "sceletonking"
script/source = "extends CharacterBody2D

const SPEED = 500.0
const JUMP_VELOCITY = -400.0
const KNOCKBACK_SPEED = 3000  # Скорость отбрасывания
const KNOCKBACK_DURATION = 0.3  # Длительность отбрасывания
@onready var pomoshnik = $\"../nushniisceleton\"
var gravity = ProjectSettings.get_setting(\"physics/2d/default_gravity\") or 980.0
var hp = 67
var damage = 5
var is_chasing = false
var direction = Vector2.ZERO 
@onready var player = $\"../seal\"
@onready var anim = $AnimatedSprite2D
var can_attack = false
@onready var timer = $Timer
var atacuu = false
var ghgh = false
var is_attacking = false 
var is_knocked_back = false  # Новое состояние - отбрасывание
var knockback_timer = 0.0  # Таймер для отбрасывания
var knockback_direction = Vector2.ZERO  # Направление отбрасывания
var dierection

func _physics_process(delta: float) -> void:
	if not player:
		return

	
	# Обработка отбрасывания
	if is_knocked_back:
		knockback_timer -= delta
		if knockback_timer <= 0:
			is_knocked_back = false
		else:
			# Применяем отбрасывание
			velocity.x = knockback_direction.x * KNOCKBACK_SPEED
			# Гравитация все еще действует
			if not is_on_floor():
				velocity.y += 100
			move_and_slide()
			return  # Выходим из функции, чтобы не выполнялась обычная логика
	
	# Обычная логика врага (только если не в состоянии отбрасывания)
	# Гравитация
	if not is_on_floor():
		velocity.y += 10
	else:
		if is_chasing and player.position.y < position.y and not is_attacking:
			jump()

	direction = (player.position - position).normalized()
	

	if is_chasing:
		velocity.x = direction.x * SPEED
	else:
		velocity.x = 0

	if is_attacking:
		pass
	elif is_chasing:
		anim.play(\"run\")
	else:
		anim.play(\"default\")

	move_and_slide()
	
	# Поворот спрайта
	update_sprite_direction()

func update_sprite_direction():
	if direction.x < 0:
		anim.flip_h = true
	elif direction.x > 0:
		anim.flip_h = false

func _on_area_2d_body_entered(body: Node2D) -> void:
	if body == player and not is_knocked_back:
		is_chasing = true

func _on_area_2d_body_exited(body: Node2D) -> void:
	if body == player:
		is_chasing = false

func jump():
	velocity.y = JUMP_VELOCITY

func sceletbol():
	if can_attack:
		hp -= 1
		queue_free()
		print(\"attacka прошла успешно\")

func sceletdeath():
	queue_free()
	
func fhdf():
	if hp <= 0:
		sceletdeath()
		print(\"враг поежден\")

func attakuu(_a):
	if atacuu and player:
		print(player.hp)
		player.hp -= 1
		if player.hp <= 0:
			sealleave()  

func _on_area_2d_2_body_entered(body: Node2D) -> void:
	if body == player:
		ghgh = true
		atacuu = true
		is_attacking = true  
		anim.play(\"attack\")  
		print(\"фаааааааааа\")
		timer.start()

func _on_area_2d_2_body_exited(body: Node2D) -> void:
	if body == player:
		atacuu = false
		ghgh = false
		is_attacking = false 
		timer.stop()
		print(\"сольььььььь\")

func _on_timer_timeout() -> void:
	attakuu(player)

func _on_animated_sprite_2d_animation_finished():
	if anim.animation == \"attack\":
		is_attacking = false 

func sealleave():
	if player:
		player.queue_free()
		
func take_damage(a):
	hp -= a


func _on_area_2d_3_body_entered(body: Node2D) -> void:
	if body == player:
		velocity.x = player.pocition
			


func _on_area_2d_4_body_entered(body: Node2D) -> void:
	if body == player:
		pomoshnik.position = player.position



func _on_area_2d_5_body_entered(body: Node2D) -> void:
	if body == player:
		anim.play(\"ataknish\")
		position = player.position

	
func ddd():
	dierection = (player.position - position).normalized()
	
"

[sub_resource type="SpriteFrames" id="SpriteFrames_hm1qr"]
animations = [{
"frames": [{
"duration": 1.0,
"texture": ExtResource("1_pw6g7")
}, {
"duration": 1.0,
"texture": ExtResource("2_hm1qr")
}, {
"duration": 1.0,
"texture": ExtResource("3_4ikyj")
}],
"loop": true,
"name": &"ataka",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": ExtResource("1_pw6g7")
}, {
"duration": 1.0,
"texture": ExtResource("4_ll65m")
}, {
"duration": 1.0,
"texture": ExtResource("5_kpn47")
}],
"loop": true,
"name": &"ataknish",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": ExtResource("1_pw6g7")
}, {
"duration": 1.0,
"texture": ExtResource("6_trgko")
}, {
"duration": 1.0,
"texture": ExtResource("7_vr30h")
}],
"loop": true,
"name": &"rivok",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": ExtResource("1_pw6g7")
}, {
"duration": 1.0,
"texture": ExtResource("8_ws33q")
}],
"loop": true,
"name": &"run",
"speed": 5.0
}]

[sub_resource type="CapsuleShape2D" id="CapsuleShape2D_4ikyj"]
radius = 56.0
height = 238.0

[sub_resource type="CircleShape2D" id="CircleShape2D_ll65m"]
radius = 176.55594

[sub_resource type="CircleShape2D" id="CircleShape2D_kpn47"]
radius = 489.53244

[sub_resource type="RectangleShape2D" id="RectangleShape2D_pw6g7"]
size = Vector2(1591, 52)

[sub_resource type="CircleShape2D" id="CircleShape2D_pw6g7"]
radius = 77.201035

[node name="CharacterBody2D" type="CharacterBody2D"]
script = SubResource("GDScript_pw6g7")

[node name="AnimatedSprite2D" type="AnimatedSprite2D" parent="."]
position = Vector2(-3.1249967, -40.75)
scale = Vector2(0.693038, 0.79096985)
sprite_frames = SubResource("SpriteFrames_hm1qr")
animation = &"ataka"

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
light_mask = 0
position = Vector2(-7, -48)
shape = SubResource("CapsuleShape2D_4ikyj")

[node name="Area2D2" type="Area2D" parent="."]

[node name="CollisionShape2D" type="CollisionShape2D" parent="Area2D2"]
light_mask = 0
position = Vector2(-9, -48)
shape = SubResource("CircleShape2D_ll65m")

[node name="Area2D" type="Area2D" parent="."]

[node name="CollisionShape2D" type="CollisionShape2D" parent="Area2D"]
light_mask = 2
position = Vector2(-7, -46)
shape = SubResource("CircleShape2D_kpn47")

[node name="Timer" type="Timer" parent="."]
wait_time = 0.385

[node name="MeshInstance2D" type="MeshInstance2D" parent="."]

[node name="Area2D3" type="Area2D" parent="."]

[node name="CollisionShape2D" type="CollisionShape2D" parent="Area2D3"]
position = Vector2(-5, -138)
shape = SubResource("RectangleShape2D_pw6g7")

[node name="Area2D4" type="Area2D" parent="."]

[node name="CollisionShape2D" type="CollisionShape2D" parent="Area2D4"]
position = Vector2(-307, -299)
shape = SubResource("CircleShape2D_pw6g7")

[node name="Area2D5" type="Area2D" parent="."]

[node name="CollisionShape2D" type="CollisionShape2D" parent="Area2D5"]

[connection signal="body_entered" from="Area2D2" to="." method="_on_area_2d_2_body_entered"]
[connection signal="body_exited" from="Area2D2" to="." method="_on_area_2d_2_body_exited"]
[connection signal="body_entered" from="Area2D" to="." method="_on_area_2d_body_entered"]
[connection signal="timeout" from="Timer" to="." method="_on_timer_timeout"]
[connection signal="body_entered" from="Area2D3" to="." method="_on_area_2d_3_body_entered"]
[connection signal="body_entered" from="Area2D4" to="." method="_on_area_2d_4_body_entered"]
[connection signal="area_shape_entered" from="Area2D5" to="." method="_on_area_2d_5_area_shape_entered"]
[connection signal="body_entered" from="Area2D5" to="." method="_on_area_2d_5_body_entered"]
